#!/bin/bash
# combustion: network
# Network is needed to install semanage/policycoreutils-python-utils

set -ex

## Install docker and docker-compose
zypper --non-interactive install docker docker-compose

## Change subuids and subgids
sudo usermod --add-subuids 100000-165535 --del-subuids 100000000-200000000 --add-subgids 100000-165535 --del-subgids 100000000-200000000 dockremap

# Mount home subvolume
mount -o subvol=/@/home /dev/disk/by-partlabel/p.lxroot /home

# Create User (ignition should set sudo up automatically)
useradd --create-home -G docker {{ hetzner_install_ansible_user }}
SSH_FOLDER="{{ ("/home/", hetzner_install_ansible_user, ".ssh") | path_join }}"
mkdir -pm700 "$SSH_FOLDER"
cat > "$SSH_FOLDER/authorized_keys" <<EOF
{{ lookup('ansible.builtin.file', ansible_ssh_private_key_file+'.pub') }}
EOF
chown {{ hetzner_install_ansible_user }}:users -R "$SSH_FOLDER"
umount /home

#-------- Selinux
# Install semanage
zypper --non-interactive install policycoreutils-python-utils
# Add port to selinux
semanage port --add -t ssh_port_t -p tcp {{ hetzner_install_ansible_port }}
# Uninstall semanage
zypper --non-interactive remove policycoreutils-python-utils

# Install python for ansible
zypper --non-interactive install python3 python3-docker

# Changing GRUB Timeout
sed -i '/^GRUB_TIMEOUT=/s/\([0-9]\+\)$/2/' /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg

# Creating subvolume and adding config to snapper
# Apparently /dev/disk/by-partlabel/p.spare does not exist
mount /dev/disk/by-label/SPARE /mnt
btrfs -q subvolume create /mnt/container-volumes
mkdir /mnt/container-volumes/.snapshots
umount /mnt

sed -i '/^SNAPPER_CONFIGS/s/"\(.*\)"/"\1 container-volumes"/' /etc/sysconfig/snapper
