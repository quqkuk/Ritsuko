---
- name: Installing OS to the Magisystem
  hosts: hetzner
  gather_facts: false
  pre_tasks:
    # Check for connection, skip the play if the OS is already installed
    # (and thus the server is accessible through custom port and username)
    - name: Checking connection
      ansible.builtin.wait_for_connection:
        timeout: 10
      register: hetzner_connected
      ignore_errors: true

    - name: Skip play if OS is already installed
      ansible.builtin.meta: end_host
      when: hetzner_connected is not failed

    - name: Setting default ssh port and username
      ansible.builtin.set_fact:
        ansible_port: 22
        ansible_user: root
  roles:
    - role: hetzner/install
  tasks:
    - name: Remove host from Controller's known hosts
      delegate_to: localhost
      connection: local
      ansible.builtin.known_hosts:
        name: '{{ ansible_host }}'
        state: absent
    - name: Restoring port and username
      ansible.builtin.set_fact:
        ansible_port: '{{ hetzner_install_ansible_port }}'
        ansible_user: '{{ hetzner_install_ansible_user }}'
    - name: Waiting for server to come back up online after reboot
      ansible.builtin.wait_for_connection: {}
    - name: Rebooting to new snapshot and refreshing partition table
      become: true
      ansible.builtin.reboot:
        msg: Rebooting to new snapshot
    - name: Waiting for server to come back up online after reboot
      ansible.builtin.wait_for_connection: {}
    - name: Adding port to firewalld
      become: true
      ansible.posix.firewalld:
        port: '{{ ansible_port }}/tcp'
        state: enabled
        permanent: true
        offline: true
      when: ansible_port != 22
    - name: Removing ssh from firewalld
      become: true
      ansible.posix.firewalld:
        service: ssh
        state: disabled
        permanent: true
        offline: true
      when: ansible_port != 22
    - name: Enable firewalld
      become: true
      ansible.builtin.systemd_service:
        name: firewalld.service
        enabled: true
        state: started
    - name: Restart docker
      become: true
      ansible.builtin.systemd_service:
        name: docker.service
        enabled: true
        state: restarted

- name: Managing containers on the Magisystem
  hosts: magisystem
  vars:
    container_volumes_folder: /var/container-volumes
    container_config_folder: '{{ (ansible_facts.env.HOME, "config") | path_join }}'
    mail_server:
      # SMTP Host Emails are sent to
      host: '{{ mail_server_settings["host"] | default("") | trim }}'
      port: '{{ mail_server_settings["port"] | default("587") | int | string }}'
      # Optionally authenticate (don't add quotation marks to you password)
      username: '{{ mail_server_settings["username"] | trim | default("") }}'
      password: '{{ mail_server_settings["password"] | default("") }}'
      # Use StartTLS
      use_tls: '{{ mail_server_settings["use_tls"] | default("false") | bool | string }}'
      # Use SSL
      use_ssl: '{{ mail_server_settings["use_ssl"] | default("false") | bool | string }}'
      timeout: '{{ mail_server_settings["timeout"] | default("30") | int | string }}'
  roles:
    - role: edge/setup
    - role: edge/watchtower
      tags:
        - watchtower
        - updates
    - role: edge/traefik
      tags:
        - reverse-proxy
        - traefik
    - role: edge/authentik
      tags:
        - auth
        - authentik
    - role: edge/bitwarden
      tags:
        - password
        - bitwarden
        - vaultwarden
      when: authentik_ldap_token is defined
    - role: edge/nextcloud
      tags:
        - cloud
        - nextcloud
    - role: edge/rss-bridge
      tags:
        - rss
    - role: edge/piped
      tags:
        - piped

- name: Managing containers on Ayanami
  hosts: ayanami
  vars:
    container_volumes_folder: /var/container-volumes
    container_config_folder: '{{ (ansible_facts.env.HOME, "config") | path_join }}'
    storage_pool_folder: /var/storage-pool
  roles:
    - role: ayanami/setup
    #- role: ayanami/samba
    - role: edge/setup
    - role: edge/watchtower
      tags:
        - watchtower
        - updates
    - role: edge/traefik
      tags:
        - reverse-proxy
        - traefik
    - role: ayanami/fix-docker-internal-firewalld
      tags:
        - reverse-proxy
        - traefik
        - watchtower
        - updates

- name: Configuring DNS for Migadu
  hosts: localhost
  tasks:
    - name: Creating DNS Records
      ansible.builtin.include_role:
        name: hetzner/dns
        tasks_from: migadu-mail
        defaults_from: migadu-mail
  tags:
    - mail
